## 如何监控资源加载失败

### 方案一：script onerror

1. 给 script 标签添加上 onerror 属性，这样在加载失败时触发事件回调，从而捕捉到异常。

   - `<script onerror="onError(this)"></script> `

2. 借助构建工具 ( 如 webpack 的 [script-ext-html-webpack-plugin](https://www.npmjs.com/package/script-ext-html-webpack-plugin) 插件) ，可以轻易地完成对所有 script 标签自动化注入 onerror 标签属性。

   ```javascript
   new ScriptExtHtmlWebpackPlugin({
       custom: {
         test: /\.js$/,
         attribute: 'onerror',
         value: 'onError(this)'
       }
    })
   ```

   

### 方案二：window.addEventListener

1. 是否可以减少 onerrror 标签大量注入呢？因为 onerror 的事件并不会向上**冒泡**，window.onerror 接收不到加载失败的错误。**冒泡虽不行，但捕获可以**！

   ```javascript
   window.addEventListener('error', (event) => {
     if (!(event instanceof ErrorEvent)) {
       // todo
     }
   }, true);
   ```



## 优化资源加载失败

### 方案一：加载失败时，刷新页面 (reload）

1. 当资源加载失败时，刷新页面可能是最简单直接的尝试恢复方式。
2. 当监控到资源加载失败时，我们通过 location.reload(true) 强制浏览器刷新重新加载资源，并且为了防止出现一直刷新的情况，结合了 SessionStorage 限制自动刷新次数

### 方案二：针对加载失败的文件进行重加载

1. 替换域名动态重加载
2. 为了防止域名劫持等导致加载失败的原因，对加载失败文件采用替换域名的方式进行重加载。
3. 然而，失败资源重加载成功后，页面原有的加载顺序可能发生变化，最终执行顺序发现变化也将导致执行异常。

### 保证 JS 按顺序执行

1. 在不需要考虑兼容性的情况下，资源加载失败时通过 document.write 写入新的 script 标签，可以阻塞后续 script 脚本的执行，直到新标签加载并执行完毕，从而保证原来的顺序。但它在 IE、Edge 却无法正常工作
2. 需要兼容性，则需要增加 “管理 JS 执行顺序” 的逻辑，先检查所依赖的文件是否都加载完成，再执行业务逻辑。当存在加载失败时，则会等待文件加载完成后再执行，从而保证正常执行。
3. 在默认情况下，业务代码的执行不会判断配置的 external 模块是否存在。所以当 external 文件未加载完成或加载失败时，使用对应模块将会导致报错。因此需要保证external全部加载完 [wait-external-webpack-plugin](https://github.com/joeyguo/wait-external-webpack-plugin) ，才可以执行



## 参考

1. https://github.com/Nikaple/assets-retry
   - 对于vue3，通过transformIndexHtml直接将retry插件，插入到head末尾即可，
2. 






































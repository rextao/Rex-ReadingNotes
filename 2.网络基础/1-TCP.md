# TCP

## 概述

1. 因特网有两个核心协议： IP 和 TCP。 
   - IP，即 Internet Protocol（因特网协议），负责联网主机之间的路由选择和寻址； 
   - TCP，即 Transmission Control Protocol（传输控制协议），负责在不可靠的传输信道之上提供可靠的抽象层，向应用层隐藏了大多数网络 通信的复杂细节，比如丢包重发、按序发送、拥塞控制及避免、数据完整，等等  。 
   - TCP/IP 也常被称为 “因特网协议套件”（ Internet Protocol Suite）  
2. TCP 数据流可以确保发送的所有字节能够完整地被接收到，而且到达客户端的顺序也一样。TCP 专门为精确传送做了优化，但并未过多顾及时间 。
3. HTTP 标准并未规定 TCP 就是唯一的传输协议 ，可以使用任意协议发送http消息
4. 理解 TCP 的某些核心机制就成为了优化 Web 体验的必修课。虽然我们一般不会直接使用TCP 套接口，但应用层的一些决定可能会对 TCP 以及底层网络的性能产生极大影响。
5. IPv4 中的 4 表示 TCP/IP 协议的第 4 个版本，发布于 1981 年 9 月  

## 三次握手  

1. 所有 TCP 连接一开始都要经过三次握手 
2. 三次握手
   - 客户端发送syn包到服务器，并进入SYN_SEND状态，等待服务器确认
   - 服务器收到syn包，发送一个SYN包，即SYN+ACK包，此时服务器进入SYN_RECV状态
   - 客户端收到服务器的SYN+ACK包，向服务器发送确认包ACK，此包发送完毕，客户端和服务器进入ESTABLISHED状态，完成三次握手。
3. 理解三次握手

- 进行1次握手：A向B发送信息，但并不知道B是否收到信息
- 进行2次握手：B接到A信息后，告诉A已经收到信息，但并不知道A是否收到B信息
- 进行3次握手：A收到B的信息后，就知道B是可以收到信息的，即可以通信了

4. 三次握手带来的延迟使得每创建一个新 TCP 连接都要付出很大代价。而这也决定了提高 TCP 应用性能的关键，在于想办法重用连接。  

## 四次挥手

1. 即终止TCP连接，需要客户端和服务端总共发送4个包确认连接的断开
2. ![1555818997761](../2.%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/1.Web%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/imgs/1555818997761.png)
3. 第一次挥手：
   - Clien发送一个FIN，用来关闭Client到Server的数据传送，Client进入FIN_WAIT_1状态。
4. 第二次挥手：
   - Server收到FIN后，发送一个ACK给Client,Server进入CLOSE_WAIT状态。
5. 第三次挥手：
   - Server发送一个FIN，用来关闭Server到Client的数据传送，Server进入LAST_ACK状态。
6. 第四次挥手：
   - Client收到FIN后，Client进入TIME_WAIT状态，发送ACK给Server，Server进入CLOSED状态，完成四次握手。

## 为何四次挥手

1. 建立连接时，当Server端收到Client端的SYN连接请求报文后，可以直接发送SYN+ACK报文
2. 但当Server端收到FIN报文时，很可能并不会立即关闭SOCKET，所以只能先回复一个ACK报文，告诉Client端，"你发的FIN报文我收到了"。只有等到Server端所有的报文都发送完了，才能发送FIN报文，因此不能一起发送。故需要四步握手。



## 拥塞预防及控制  

### 概述

1. 路由接收信息如果超过自身处理速度，会出现延迟；
2. 当系统出现轻度拥塞时，路由的队列中有大量的数据排队等待路由
3. 系统严重拥塞时，路由接收数据超过路由容量时，路由只有丢掉接收数据
4. 由于TCP采用超时重传机制，如拥塞不加以控制，会出现死循环，使整个网路瘫痪，这种现象称为拥塞崩溃

### 流量控制  

1. 概述：流量控制就是相互交流自己的接收能力，避免发送端发送过多数据
2. 流量控制是一种预防发送端过多向接收端发送数据的机制。否则，接收端可能因为忙碌、负载重或缓冲区既定而无法处理
3. 为实现流量控制， TCP 连接的每一方都要通告自己的接收窗口（ rwnd），如果其中一端跟不上数据传输，那它可以向发送端通告一个较小的窗口
4. 发送rwnd贯穿TCP的整个生命周期，以便动态调整两端数据速率
5. 如果你的服务器或客户端的连接不能 完全利用现有带宽，那往往该先查一查窗口大小  

### 慢启动  

1. 主要解决充分利用带宽问题，连接建立之初，并不知道各自带宽是多少
2. 比如，看视频时，视频网站提供最高速的下载，但家人突然下载个软件包，视频网站需要调整下载速度，否则会使数据在网关堆积，降低网络效率，因此根据网络状况动态改变速度是有利的
3. 慢启动理解：开始两端并不知道带宽，开始先发送个小的包数据，然后逐渐增大发送数据量，达到带宽最大利用率
4. 用拥塞窗口大小（cwnd）有几个TCP段表示开始发送包大小，一个TCP段约1460字节，最大可设置为10段，即最开始发送数据包最多为10*1460字节=14.26KB
5. 把服务器的初始 cwnd 值增大到 RFC 6928 新规定的10 段（IW10），是提升用户体验以及所有 TCP 应用性能的最简单方式。
6. 慢启动对小文件文件传输非常不利

### 拥塞预防  

1. 拥塞预防算法把丢包作为网络拥塞的标志，即路径中某个连接或路由器已经拥堵了， 以至于必须采取删包措施。因此，必须调整窗口大小，以避免造成更多的包丢失， 从而保证网络畅通。 
2. 如果你看到过 TCP 连接的吞吐量跟踪曲线，发现该曲线呈锯齿状，这是拥塞控制和预防算法在调整拥塞窗口，进而消除网络中的丢包问题  

## 窗口机制

1. TCP协议里窗口机制有2种：一种是固定的窗口大小；一种是滑动的窗口。 
2. 固定窗口的问题：

- ![1543801869052](../2.%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/1.Web%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/imgs/1543801869052.png)
- 假设窗口的大小是1，也是就每次只能发送一个数据只有接受方对这个数据进行确认了以后才能发送第2个数据
- 如窗口过小，传输较大数据，会导致需要等待接收方ack，造成延迟
- 如窗口过大，但接收数据窗口过小，会导致链路拥塞

3. 滑动窗口
   - ![1543807906500](../2.%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/1.Web%E6%80%A7%E8%83%BD%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97/imgs/1543807974992.png)
   - 假设开始发送窗口是3，发送3个数据，ack为2，知道接收方只能接受2个数据，第三个数据没有收到，故从第三个数据再发送
   - 当链路变好了或者变差了这个窗口还会发生变化

## 带宽延迟积  

1. 数据链路的容量与其端到端延迟的乘积。这个结果就是任意时刻处于在途未确认状态的最大数据量。  
2. 无论发送端发送的数据还是接收端接收的数据超过了未确认的最大数据量，都必须停下来等待另一方 ACK 确认某些分组才能继续。
3. 意味着，如果rwnd与cwnd为16KB时，往返时间100ms，TCP连接速率不会超过1.31Mbit/s(16\*1024\*8/0.1s/(10^6))
4. 因为，如高于这个速率传输，接收窗口会出现拥塞，如想提高传输速率，需要等待接收方返回ACK后才可以
5. 结论：如在高速连接的客户端与服务器之间，实际传输速度只有可用带宽的几分之一，那窗口大小很可能就是罪魁祸首。  

## 队首阻塞  

1. 由于TCP是可靠传输，如中途有一个分组丢失，接收端需要缓存其他分组，然后等待丢失分组重发；对于应用层的结果就是必须等分组全部到达后才可以访问数据；这种现象叫TCP队首阻塞
2. 这个问题对于应用程序而言，会造成分组到达时间会存在无法预知的延迟变化。这个时间变化通常被称为抖动 
3. 但某些应用不需要可靠交付或按顺序交付，如每个分组都是独立信息，或者每个消息都会覆盖前面的消息，这些情况TCP不支持了

## 针对TCP的优化建议  

### 服务器配置调优  

1. TCP 的最佳实践以及影响其性能的底层算法一直在与时俱进，而且大多数变化都只在最新内核中才有实现  
2. 让你的服务器跟上时代是优化发送端 和接收端 TCP 栈的首要措施 （虽然可能升级风险很大，某些服务根据特定内核开发）
3. 调优 TCP 性能可以让服务器和客户端之间达到最大吞吐量和最小延迟 
4. 主要是：
   - 增大TCP的初试拥塞窗口，增大第一次传输数据量
   - 连接空闲时禁用慢启动，改善瞬间发送数据的长TCP连接的性能
   - 等

### 应用程序行为调优  

1. 重用 TCP 连接是提升性能的关键  
2. 减少不必要的数据传输也是很大的优化，如通过压缩算法把发送数据降到最低等

### 总结

1. 把服务器内核升级到最新版本
2. 确保 cwnd 大小为 10；
3. 禁用空闲后的慢启动； 
4. 确保启动窗口缩放； 
5. 减少传输冗余数据；
6. 压缩要传输的数据；
7. 把服务器放到离用户近的地方以减少往返时间；
8. 尽最大可能重用已经建立的 TCP 连接  